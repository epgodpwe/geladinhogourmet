"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var HurrytimerAction=function(){function t(e){_classCallCheck(this,t),this.elementRef=e}return _createClass(t,[{key:"hide",value:function(){if(!this.elementRef.find(".hurrytimer-campaign-message").length){var e=this.elementRef.closest(".hurrytimer-sticky");e.length?e.remove():this.elementRef.remove()}}},{key:"displayMessage",value:function(e){var t='<div class="hurrytimer-campaign-message">'.concat(e,"</div>");this.elementRef.html(t)}}],[{key:"redirect",value:function(e){document.body.style.opacity="0",document.body.style.display="none",hurrytimer_ajax_object.redirect_no_back?window.location.replace(e):window.location.href=e}},{key:"hideAddToCartButton",value:function(){var e=document.querySelector(".single_add_to_cart_button");e&&e.remove()}}]),t}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var HurrytimerCampaign=function(){function i(e,t){_classCallCheck(this,i),this.config=t,this.elementRef=e,this.actionsOptions=hurrytimer_ajax_object.actionsOptions,this.restartOptions=hurrytimer_ajax_object.restartOptions,this.recurTimeoutId=-1,this.retryCount=0}return _createClass(i,[{key:"setCookie",value:function(e){Cookies.set(this.config.cookieName,e,{expires:365})}},{key:"getEndDate",value:function(){if(this.config.isRegular)return new Date(this.config.endDate);var e=new Date(this.config.endDate);return(!this.config.endDate||this.allowReset()||this.allowRestart())&&(e=this.calculateDate()),this.setCookie(e.getTime()),this.sendTimestamp(),e}},{key:"sendTimestamp",value:function(){if(void 0!==jQuery.ajax){var e={url:hurrytimer_ajax_object.ajax_url,async:!0,type:"POST",data:{nonce:hurrytimer_ajax_object.ajax_nonce,timestamp:Cookies.get(this.config.cookieName),cid:this.config.id,action:"set_timestamp"}};jQuery.ajax(e)}}},{key:"allowReset",value:function(){return this.config.reset}},{key:"allowRestart",value:function(){return!this.config.isRegular&&(this.isExpired()&&(this.allowRestartImmediately()||this.allowRestartAfterReload()))}},{key:"isExpired",value:function(){var e=new Date;return this.config.endDate<e}},{key:"allowRestartAfterReload",value:function(){return parseInt(this.config.restart)===parseInt(this.restartOptions.afterReload)}},{key:"allowRestartImmediately",value:function(){return parseInt(this.config.restart)===parseInt(this.restartOptions.immediately)}},{key:"hasAction",value:function(){return this.config.actions.length}},{key:"calculateDate",value:function(){var e=new Date;return e.setSeconds(e.getSeconds()+this.config.duration),e}},{key:"executeActions",value:function(){if(1===parseInt(hurrytimer_ajax_object.disable_actions))return!1;if(this.hasAction()){var e=!0,t=!1,i=void 0;try{for(var r,n=this.config.actions[Symbol.iterator]();!(e=(r=n.next()).done);e=!0){var a=r.value,o=new HurrytimerAction(this.elementRef);switch(a.id){case this.actionsOptions.redirect:HurrytimerAction.redirect(a.redirectUrl);break;case this.actionsOptions.hideAddToCartButton:HurrytimerAction.hideAddToCartButton();break;case this.actionsOptions.displayMessage:o.displayMessage(a.message);break;case this.actionsOptions.hide:o.hide()}}}catch(e){t=!0,i=e}finally{try{e||null==n.return||n.return()}finally{if(t)throw i}}}}},{key:"maybeShowCampaign",value:function(){this.elementRef.length&&this.elementRef.removeClass("hurryt-loading");var e=this.elementRef.closest(".hurrytimer-sticky");e.length&&e.removeClass("hurryt-loading")}},{key:"run",value:function(){var t=this;this.elementRef.countdown(this.getEndDate(),function(e){return t.onCountdownUpdate(e)});var e=this.elementRef.closest(".hurrytimer-sticky");this.handleStickyBar(e)}},{key:"handleStickyBar",value:function(e){var t=this;0!==e.length&&(null==Cookies.get("_ht_CDT-".concat(this.config.id,"_dismissed"))?e.on("click",".hurrytimer-sticky-close",function(){return t.onStickyBarDismiss(e)}):this.hideStickyBar(e))}},{key:"hideStickyBar",value:function(e){if(0!==e.length){var t="0px"===e.css("top");e.remove(),t?jQuery("body").css("margin-top",0):jQuery("body").css("margin-bottom",0)}}},{key:"onStickyBarDismiss",value:function(e){this.hideStickyBar(e),Cookies.set("_ht_CDT-".concat(this.config.id,"_dismissed"),"1",{expires:+hurrytimer_ajax_object.sticky_bar_hide_timeout})}},{key:"onCountdownUpdate",value:function(e){this.render(e),this.maybeShowCampaign(),e.elapsed&&"finish"===e.type&&(this.executeActions(),this.maybeRecur(),this.allowRestartImmediately()&&this.run())}},{key:"render",value:function(e){this.elementRef.find(".hurrytimer-timer").html(e.strftime(this.config.template))}},{key:"maybeRecur",value:function(){var i=this;this.config.recurr&&void 0!==jQuery.ajax&&(clearTimeout(this.recurTimeoutId),this.recurTimeoutId=setTimeout(function(){jQuery.ajax({url:hurrytimer_ajax_object.ajax_url,data:{action:"next_recurrence",nonce:hurrytimer_ajax_object.ajax_nonce,id:i.config.id},error:function(){10!==i.retryCount&&(i.retryCount++,setTimeout(function(){i.maybeRecur()},1e3))},success:function(e){var t=e.data;i.retryCount=0,t&&(isNaN(t.endTimestamp)||(i.config.endDate=t.endTimestamp,i.run()))}})},1e3*this.config.timeToNextRecurrence))}}]),i}();!function(r){var n=r("body");r(".hurrytimer-campaign").each(function(){var e=r(this),t=e.closest(".hurrytimer-sticky");t.length&&(n.append(t),r(window).resize(function(){"0px"===t.css("top")?n.css("margin-top",t.outerHeight()):n.css("margin-bottom",t.outerHeight())}),setTimeout(function(){r(window).trigger("resize")}));var i=e.data("config");void 0!==i&&(e.removeAttr("data-config"),new HurrytimerCampaign(e,i).run())})}(jQuery);